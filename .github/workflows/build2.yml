name: æ­£å¼ç‰ˆ zink (aarch64, Mesa Release)

on:
  workflow_dispatch:
  schedule:
    - cron: '0 6 * * *'  # æ¯å¤©æ—©ä¸Š 6 ç‚¹è‡ªåŠ¨æ„å»ºæœ€æ–°æ­£å¼ç‰ˆ

permissions:
  contents: write  # å…è®¸ GITHUB_TOKEN åˆ›å»º Tag ä¸ Release

env:
  INSTALL_ROOT: /data/data/com.termux/files/usr/glibc

jobs:
  build:
    runs-on: ubuntu-24.04-arm

    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4

      - name: å®‰è£…ä¾èµ–
        run: |
          sudo sed -i "s/^Types: deb$/Types: deb deb-src/" /etc/apt/sources.list.d/ubuntu.sources
          sudo apt update
          sudo apt install -y libxrandr-dev libxxf86vm-dev libxcb-shm0-dev libxcb-glx0-dev \
            libxext-dev libx11-dev libx11-xcb-dev libxcb1-dev libxcb-dri3-dev libxcb-present-dev \
            libxcb-randr0-dev libxcb-sync-dev libxcb-xfixes0-dev libxshmfence-dev libdrm-dev \
            libgbm-dev libegl1-mesa-dev libexpat1-dev libwayland-dev python3-pip
          pip3 install --user meson ninja mako

      - name: æ‹‰å– Mesa æœ€æ–°æ­£å¼ç‰ˆ
        run: |
          git clone --depth=1 https://gitlab.freedesktop.org/mesa/mesa.git
          cd mesa
          LATEST_TAG=$(git describe --tags `git rev-list --tags --max-count=1`)
          git checkout $LATEST_TAG
          echo "Mesa æ­£å¼ç‰ˆ: $LATEST_TAG"
          VERSION=${LATEST_TAG#v}
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "MESA_COMMIT=$(git rev-parse HEAD)" >> $GITHUB_ENV
          echo "MESA_DATE=$(git log -1 --format=%cd --date=iso)" >> $GITHUB_ENV

      - name: æ„å»º Mesa (Zink only)
        run: |
          cd mesa
          sudo mkdir -p $INSTALL_ROOT
          sudo chmod 777 -R /data

          mkdir -p builddir
          meson setup builddir \
            --libdir=lib \
            --prefix=$INSTALL_ROOT \
            -Dbuildtype=release \
            -Dgallium-drivers=zink,freedreno \
            -Dvulkan-drivers= \
            -Dglvnd=disabled \
            -Dplatforms=x11 \
            -Degl-native-platform=x11 \
            -Dxmlconfig=enabled \
            -Dllvm=disabled \
            -Dopengl=true \
            -Dglx=dri \
            -Dglx-direct=true \
            -Dvideo-codecs=all \
            -Dmediafoundation-codecs=all \
            -Degl=enabled

          ninja -C builddir
          ninja -C builddir install

          cd $INSTALL_ROOT/lib
          rm -rf dri gbm pkgconfig

          echo "ğŸ“¦ æ‰“åŒ…åº“æ–‡ä»¶..."
          tar -czf $GITHUB_WORKSPACE/termux-glibc-zink-${VERSION}-aarch64.tar.gz *
          du -sh $GITHUB_WORKSPACE/termux-glibc-zink-${VERSION}-aarch64.tar.gz

      - name: åˆ›å»ºæˆ–æ›´æ–° Tag
        run: |
          TAG_NAME="zink-${VERSION}-$(date +'%Y-%m-%d')"
          echo "TAG_NAME=$TAG_NAME" >> $GITHUB_ENV

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          echo "ğŸ” æ£€æŸ¥æ˜¯å¦å·²æœ‰ Tag: $TAG_NAME"
          if git ls-remote --tags origin | grep -q "refs/tags/$TAG_NAME"; then
            echo "â™»ï¸ å‘ç°åŒå Tagï¼Œå‡†å¤‡æ›´æ–°..."
            git tag -fa "$TAG_NAME" -m "Mesa Zink rebuild $TAG_NAME"
            git push origin ":refs/tags/$TAG_NAME" || true
            git push origin "$TAG_NAME" --force
          else
            echo "ğŸ†• åˆ›å»ºæ–° Tag: $TAG_NAME"
            git tag -a "$TAG_NAME" -m "Mesa Zink auto build for $TAG_NAME"
            git push origin "$TAG_NAME"
          fi

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: termux-glibc-zink-${{ env.VERSION }}-aarch64
          path: termux-glibc-zink-${{ env.VERSION }}-aarch64.tar.gz

      - name: å‘å¸ƒåˆ° GitHub Releaseï¼ˆè‡ªåŠ¨è¦†ç›–ï¼‰
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.TAG_NAME }}
          name: "zink ${{ env.VERSION }} (aarch64, Termux glibc)"
          draft: false
          prerelease: false
          generate_release_notes: true
          files: termux-glibc-zink-${{ env.VERSION }}-aarch64.tar.gz
          append_body: true
          body: |
            âœ… è‡ªåŠ¨æ„å»ºå®Œæˆï¼
            - Mesa ç‰ˆæœ¬: ${{ env.VERSION }}
            - Commit: ${{ env.MESA_COMMIT }}
            - æäº¤æ—¶é—´: ${{ env.MESA_DATE }}
            - æ„å»ºå¹³å°: Ubuntu 24.04 ARM64
            - Tag: ${{ env.TAG_NAME }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: è¾“å‡ºç‰ˆæœ¬ä¿¡æ¯
        run: |
          echo "âœ… Zink æ„å»ºå®Œæˆ"
          echo "ç‰ˆæœ¬å·: $VERSION"
          echo "Tag: $TAG_NAME"
          echo "Commit: ${MESA_COMMIT}"
          echo "æ—¶é—´: ${MESA_DATE}"
